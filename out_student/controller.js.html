<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controller.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controller.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>let Student = require('../models/student.model');
const bcrypt = require("bcryptjs");

/**
 * Permettre de récupérer un tableau contenant tous les étudiants qui existent dans la base de données
 * @param res - le resultat qui est un tableau d'étudiants
 */
exports.getAll = function(req, res) {
    Student.find(function(err, students) {
        if (err) {
            console.log(err);
        } else {
            res.json(students);
        }
    });
}
/**
 * de la base de données des utilisateurs (users)
 *@prop {string} l - LE nom de l'étudiant.
 *@prop {string} firs -  LE prénom de l'étudiant.
 *@prop {string} level -  LE niveau d'étude de l'étudiant.
 *@prop {string} group -  LE droupe l'étudiant.
 *@prop {string} matricule -  La matricurle de l'étudiant.
 *@prop {string} section -  La section de l'étudiant.

 */

/**
 * Permettre d'obtenire l'objet étudiant du ID si il existe dans la base de données 
 * @param req - la requete contenant l'id de l'étudiant qu'on cherche
 * @param res - le resultat contenant l'objet étudiant en question 
 */
exports.getById = function(req, res) {
    let id = req.params.id;
    Student.findById(id, function(err,student ) {
        res.json(student);
    });
}

/**
 * Permettre de mettre à jour l'objet étudiant de ID
 * @param req - la requete contenant l 'id qu'on cherche et l'objet étudiant modifié
 */
exports.update = function(req, res) {
    Student.findById(req.params.id, function(err, student) {
        if (!student)
            res.status(404).send("data is not found");
        else
            student.last_name= req.body.last_name;
            student.first_name= req.body.first_name;
            student.level= req.body.level;
            student.group= req.body.group;
            student.section=req.body.secion;
            student.save().then(student => {
                res.json('Student updated!');
            })  
            .catch(err => {
                res.status(400).send("Update not possible");
            });
    });
}

/**
 * @param req - la requete contenant l'objet étudiant à insérer
 * @param res - le resultat contenant les informations nécessaire pour ajout d'un utilisateur relié à l'étudaint
 * @description Permettre d'ajouter un étudient. On cherche si la matricule introduite n'existait pas déja .Si c'est vérifié, on ajoute l'étudiant 
 * on génère son mot de passe et on le crypte,on génère l' email et le username et on les retourne avec son 'id' pour pouvoir ajouter un user 
 * relié à lui .
 */
exports.add = function(req, res) {
    
    let matricule = req.body.matricule;
    Student.findOne({matricule: matricule})
    .then(doc => {
        if(doc) {
            console.log("matricule existe dejà")
            res.status(400).json(doc)}
        else{
            console.log("matricule n'existe pas")
            let student = new Student(req.body);
            let userName = req.body.first_name[0]+"_"+req.body.last_name+req.body.matricule;
            let resp={
                user_name : userName,
                email : userName+"@univ.com",
                password : student.first_name,
                student_id : student.id,
            }
            bcrypt.genSalt(10, (err, salt) => {
                bcrypt.hash(resp.password, salt, (err, hash) => {
                  if (err) throw err;
                  resp.password = hash;
                  student.save()
                    .then(student => {
                        res.status(200).json(resp);
                    })
                    .catch(err => {
                        res.status(400).send('adding new student failed');
                    });
                });
              });
        }
    }).catch(err => {
        console.log(err);
    });
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#add">add</a></li><li><a href="global.html#getAll">getAll</a></li><li><a href="global.html#getById">getById</a></li><li><a href="global.html#update">update</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Fri Jan 03 2020 10:56:13 GMT+0100 (GMT+01:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
